%%
%% This is file `notebeamer.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% notebeamer.dtx  (with options: `package')
%% -----------------------------------------------------------------------
%%   Copyright (C) 2023-2025 by Mingyu Xia <myhsia@outlook.com>          *
%%                                                                       *
%%   This work may be distributed and/or modified under the conditions   *
%%   of the LaTeX Project Public License (LPPL), either version 1.3c of  *
%%   this license or (at your option) any later version.                 *
%%   The latest version of this license is in                            *
%%                                                                       *
%%       http://www.latex-project.org/lppl.txt                           *
%%                                                                       *
%%   and version 1.3c or later is part of all distributions of LaTeX     *
%%   version 2008 or later.                                              *
%%                                                                       *
%%   This work has the LPPL maintenance status `maintained'.             *
%%                                                                       *
%%   The Current Maintainer of this work is Mingyu Xia.                  *
%% -----------------------------------------------------------------------
\ProvidesExplPackage {notebeamer} {2025-08-19} {v4.5A}
  {Package for printing slides on note pages}
\cs_if_exist:NF \graphics_include:nn
  { \RequirePackage{l3graphics} }
\RequirePackage{tikz, tikzpagenodes}
\NewDocumentCommand \includebeamer { O{} m O{} }
  {
    \group_begin:
    \keys_set:nn { notebeamer / includebeamer } { #1, #3 }
    \__ntbm_include_aux:n {#2}
    \group_end:
  }
\keys_define:nn { notebeamer / includebeamer }
  {
    pos     .tl_set:N   = \l__ntbm_include_pos_tl,
      pos   .initial:n  = left,
    color   .tl_set:N   = \l__ntbm_include_color_tl,
      color .initial:n  = black,
    pages   .tl_set:N   = \l__ntbm_include_pages_tl,
      pages .initial:n  = 1,
    nup     .int_set:N  = \l__ntbm_include_nup_int,
      nup   .initial:n  = 3,
    lines   .int_set:N  = \l__ntbm_include_lines_int,
    lineno  .bool_set:N = \l__ntbm_include_lineno_bool,
      lineno .initial:n = false,
      lineno .default:n = true,
    ratio   .fp_set:N   = \l__ntbm_include_ratio_fp,
      ratio .initial:n  = .5,
    sep     .dim_set:N  = \l__ntbm_include_sep_dim,
      sep   .initial:n  = 2ex,
    lhead   .tl_set:N   = \l__ntbm_include_lhead_tl,
    rhead   .tl_set:N   = \l__ntbm_include_rhead_tl,
    unknown .code:n     = \tl_if_novalue:nF {#1}
      { \tl_set_eq:NN \l__ntbm_include_color_tl \l_keys_key_tl }
  }
\dim_new:N \l__ntbm_nup_dim
\dim_new:N \l__ntbm_include_ratio_dim
\int_new:N \l__ntbm_pages_total_int
\int_new:N \l__ntbm_pages_residue_int
\clist_new:N \l__ntbm_tmpa_clist
\cs_new_protected_nopar:Npn \__ntbm_include_aux:n #1
  {
    \graphics_get_pagecount:nN {#1} \l__ntbm_include_filepages_int
    \dim_set:Nn \l__ntbm_nup_dim { \textheight/\l__ntbm_include_nup_int }
    \dim_set:Nn \l__ntbm_include_ratio_dim
      { \fp_use:N \l__ntbm_include_ratio_fp \textwidth }
    \tl_if_eq:NnTF \l__ntbm_include_pages_tl { - }
      {
        \__ntbm_range_to_list:nN
          { 1 - \l__ntbm_include_filepages_int } \l__ntbm_tmpa_clist
      }
      {
        \exp_args:NV \__ntbm_range_to_list:nN
          { \l__ntbm_include_pages_tl } \l__ntbm_tmpa_clist
      }
    \int_set:Nn \l__ntbm_pages_total_int
      {
        \fp_eval:n
          { ceil
              ( \clist_count:N \l__ntbm_tmpa_clist/
                  \l__ntbm_include_nup_int, 0
              ) - 1
          }
      }
    \int_set:Nn \l__ntbm_pages_residue_int
      {
        \int_eval:n
          {
            \clist_count:N \l__ntbm_tmpa_clist -
            \l__ntbm_include_nup_int * \l__ntbm_pages_total_int
          }
      }
    \int_step_inline:nn { \int_use:N \l__ntbm_pages_total_int }
      {
        \clearpage
        \__ntbm_empty_note_aux:
        \int_step_inline:nn { \l__ntbm_include_nup_int }
          {
            \tikz [ remember~picture, overlay ]
              \node [ xshift = \l__ntbm_include_ratio_dim/2,
                      yshift = \fp_eval:n { -####1 + .5 } \l__ntbm_nup_dim
                    ] at (current~page~text~area.north~west)
                {
                  \includegraphics
                    [ height = \dim_eval:n
                        { \l__ntbm_nup_dim - \l__ntbm_include_sep_dim },
                      page = \clist_item:Nn \l__ntbm_tmpa_clist
                        { ####1 + \l__ntbm_include_nup_int * ( ##1 - 1 ) }
                    ] {#1}
                };
          }
        \clearpage
      }
    \__ntbm_empty_note_aux:
    \int_step_inline:nn { \int_use:N \l__ntbm_pages_residue_int }
      {
        \tikz [ remember~picture, overlay ]
          \node [ xshift = \l__ntbm_include_ratio_dim/2,
                  yshift = \fp_eval:n {( -##1 + .5 )} \l__ntbm_nup_dim
                ] at (current~page~text~area.north~west)
            {
              \includegraphics
                [ height = \dim_eval:n
                    { \l__ntbm_nup_dim - \l__ntbm_include_sep_dim },
                  page = \clist_item:Nn \l__ntbm_tmpa_clist
                    {
                      \l__ntbm_include_nup_int *
                      \l__ntbm_pages_total_int + ##1
                    }
                ] {#1}
            };
      }
    \clearpage
  }
\cs_new_protected_nopar:Nn \__ntbm_empty_note_aux:
  {
    \begin { tikzpicture } [ remember~picture, overlay ]
      \draw [ very~thick, \l__ntbm_include_color_tl, opacity = .8 ]
        (current~page~text~area.north~west) --
        (current~page~text~area.north~east)
       node [ at~start, above~right, font = \Large \bfseries ]
        { \l__ntbm_include_lhead_tl }
       node [ above~left, font = \Large \bfseries ]
        { \l__ntbm_include_rhead_tl };
      \draw [ very~thick, \l__ntbm_include_color_tl, opacity = .8 ]
        (current~page~text~area.south~west) --
        (current~page~text~area.south~east);
      \int_step_inline:nn { \l__ntbm_include_lines_int - 1 }
        {
          \draw [ thick, \l__ntbm_include_color_tl, opacity = .6 ]
            ([xshift = \l__ntbm_include_ratio_dim,
              yshift = -\textheight/\l__ntbm_include_lines_int * ##1
             ]current~page~text~area.north~west) --++
            (\dim_eval:n { \textwidth - \l__ntbm_include_ratio_dim },0);
          \bool_if:nT \l__ntbm_include_lineno_bool
            {
              \node [ font = \footnotesize, \l__ntbm_include_color_tl,
                      opacity = .4, right ] at
                ([xshift = \textwidth,
                  yshift = -\textheight/\l__ntbm_include_lines_int * (##1 - .5)
                 ]current~page~text~area.north~west)
                { \int_eval:n { ##1 } };
            }
        }
      \node [ font = \footnotesize, \l__ntbm_include_color_tl,
              opacity = .4, right ] at
        ([xshift = \textwidth,
          yshift = -\textheight + \textheight/\l__ntbm_include_lines_int * .5
         ]current~page~text~area.north~west)
        { \int_eval:n { \l__ntbm_include_lines_int } };
    \end { tikzpicture }
    \pagestyle { empty }
  }
\seq_new:N \l__ntbm_tmpa_seq
\seq_new:N \l__ntbm_tmpb_seq
\cs_new_protected_nopar:Npn \__ntbm_range_to_list:nN #1#2
  {
    \clist_clear:N #2
    \seq_set_split:Nnn \l__ntbm_tmpa_seq { , } {#1}
    \seq_map_inline:Nn \l__ntbm_tmpa_seq
      {
        \tl_if_in:nnTF {##1} { - }
          {
            \seq_set_split:Nnn \l__ntbm_tmpb_seq { - } {##1}
            \int_step_inline:nnn
              { \seq_item:Nn \l__ntbm_tmpb_seq { 1 } }
              { \seq_item:Nn \l__ntbm_tmpb_seq { 2 } }
              { \clist_put_right:Nn #2 {####1} }
          } { \clist_put_right:Nn #2 {##1} }
      }
  }
%% -----------------------------------------------------------------------
%%   This work consists of the files notebeamer.dtx,                     *
%%                                   notebeamer.ins,                     *
%%                 the derived files notebeamer.sty,                     *
%%           the documentation files notebeamer.pdf,                     *
%%                               and README.md.                          *
%% -----------------------------------------------------------------------
%%
%% End of file `notebeamer.sty'.
